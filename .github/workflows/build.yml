  name: Build

  on:
    push:
      branches: [main]
      tags: ['v*']
    pull_request:
      branches: [main]
    workflow_dispatch:

  jobs:
    build:
      strategy:
        fail-fast: false
        matrix:
          include:
            - platform: macos-latest
              target: aarch64-apple-darwin
            - platform: macos-latest
              target: x86_64-apple-darwin
            - platform: windows-latest
              target: x86_64-pc-windows-msvc

      runs-on: ${{ matrix.platform }}

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: 20

        - name: Install Rust
          uses: dtolnay/rust-action@stable
          with:
            targets: ${{ matrix.target }}

        - name: Install dependencies
          run: rustup target add ${{ matrix.target }}

        - name: Install npm dependencies
          run: npm install

        - name: Build Tauri app
          uses: tauri-apps/tauri-action@v0
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            args: --target ${{ matrix.target }}

        - name: Upload artifacts (macOS)
          if: matrix.platform == 'macos-latest'
          uses: actions/upload-artifact@v4
          with:
            name: cdMenu-${{ matrix.target }}
            path: src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg

        - name: Upload artifacts (Windows)
          if: matrix.platform == 'windows-latest'
          uses: actions/upload-artifact@v4
          with:
            name: cdMenu-${{ matrix.target }}
            path: src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
